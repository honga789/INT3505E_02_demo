{% extends "base.html" %}
{% block content %}
<h2>Quản lý Sách</h2>
<div class="toolbar">
  <input id="search" placeholder="Tìm tiêu đề/tác giả..." />
  <button id="btn-search">Tìm</button>
  <button id="btn-add">Thêm sách</button>
</div>
<table class="table" id="books_tbl">
  <thead>
    <tr>
      <th>Tiêu đề</th><th>Tác giả</th><th>Copies</th><th>Danh mục</th><th>Vị trí</th><th>Hành động</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Modal đơn giản -->
<div id="modal" class="modal hidden">
  <div class="modal-card">
    <h3 id="modal-title">Thêm/Sửa sách</h3>
    <form id="book-form">
      <input type="hidden" name="id"/>
      <label>Tiêu đề</label><input name="title" required />
      <label>Tác giả</label><input name="author" required />
      <label>Danh mục</label><input name="category" />
      <label>Publisher</label><input name="publisher" />
      <label>Năm</label><input name="year" type="number" />
      <label>Tổng bản</label><input name="total_copies" type="number" value="1" />
      <label>Khả dụng</label><input name="available_copies" type="number" value="1" />
      <label>Vị trí</label><input name="location" />
      <div class="modal-actions">
        <button type="submit">Lưu</button>
        <button type="button" id="btn-cancel">Huỷ</button>
      </div>
      <p id="modal-msg" class="msg"></p>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  if(!getToken()) { location.href='/login'; }

  const tblBody = document.querySelector('#books_tbl tbody');
  const searchInput = document.getElementById('search');
  const btnSearch = document.getElementById('btn-search');
  const btnAdd = document.getElementById('btn-add');

  const modal = document.getElementById('modal');
  const form = document.getElementById('book-form');
  const msg = document.getElementById('modal-msg');
  const btnCancel = document.getElementById('btn-cancel');

  function openModal(data){
    modal.classList.remove('hidden');
    form.reset(); msg.textContent = '';
    if(data){
      form.id.value = data.id;
      form.title.value = data.title || '';
      form.author.value = data.author || '';
      form.category.value = data.category || '';
      form.publisher.value = data.publisher || '';
      form.year.value = data.year || '';
      form.total_copies.value = data.total_copies ?? 1;
      form.available_copies.value = data.available_copies ?? 1;
      form.location.value = data.location || '';
    } else {
      form.id.value = '';
    }
  }
  function closeModal(){ modal.classList.add('hidden'); }

  btnAdd.addEventListener('click', ()=> openModal(null));
  btnCancel.addEventListener('click', closeModal);

  async function load(){
    const q = searchInput.value ? `?search=${encodeURIComponent(searchInput.value)}` : '';
    const res = await authFetch('/api/v1/books'+q);
    const data = await res.json();
    tblBody.innerHTML = '';
    data.data.forEach(b=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${b.title}</td>
        <td>${b.author}</td>
        <td>${b.available_copies}/${b.total_copies}</td>
        <td>${b.category||''}</td>
        <td>${b.location||''}</td>
        <td>
          <button data-edit="${b.id}">Sửa</button>
          <button data-del="${b.id}">Xoá</button>
        </td>`;
      tblBody.appendChild(tr);
    });
  }
  btnSearch.addEventListener('click', load);

  tblBody.addEventListener('click', async (e)=>{
    const editId = e.target.getAttribute('data-edit');
    const delId = e.target.getAttribute('data-del');
    if(editId){
      const res = await authFetch('/api/v1/books/'+editId);
      const b = await res.json();
      openModal(b);
    }
    if(delId){
      if(confirm('Xoá sách này?')){
        const res = await authFetch('/api/v1/books/'+delId, { method:'DELETE' });
        if(res.ok) load();
        else {
          const d = await res.json();
          alert(d?.error?.message || 'Không thể xoá');
        }
      }
    }
  });

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';
    const payload = {
      title: form.title.value.trim(),
      author: form.author.value.trim(),
      category: form.category.value.trim() || null,
      publisher: form.publisher.value.trim() || null,
      year: form.year.value ? parseInt(form.year.value) : null,
      total_copies: parseInt(form.total_copies.value||'1'),
      available_copies: parseInt(form.available_copies.value||'1'),
      location: form.location.value.trim() || null
    };
    const id = form.id.value;
    const method = id ? 'PUT' : 'POST';
    const url = id ? '/api/v1/books/'+id : '/api/v1/books';
    const res = await authFetch(url, { method, body: JSON.stringify(payload) });
    if(res.ok){ closeModal(); load(); }
    else {
      const d = await res.json();
      msg.textContent = d?.error?.message || 'Lỗi lưu dữ liệu';
    }
  });

  load();
</script>
{% endblock %}
