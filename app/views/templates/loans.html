{% extends "base.html" %}
{% block content %}
<h2>Mượn – Trả</h2>
<div class="grid-2">
  <section>
    <h3>Tạo phiếu mượn</h3>
    <form id="loan-form">
      <label>Chọn sách</label>
      <input id="book_search" placeholder="Gõ tiêu đề/tác giả…" autocomplete="off" />
      <input type="hidden" name="book_id" />
      <ul id="book_suggest" class="suggest hidden"></ul>

      <label>Chọn bạn đọc</label>
      <input id="member_search" placeholder="Gõ tên hoặc mã bạn đọc…" autocomplete="off" />
      <input type="hidden" name="member_id" />
      <ul id="member_suggest" class="suggest hidden"></ul>

      <label>Số ngày mượn</label><input name="due_days" type="number" value="14" />
      <button type="submit">Tạo</button>
      <p id="loan-msg" class="msg"></p>
    </form>
  </section>
  <section>
    <h3>Danh sách đang mượn</h3>
    <table class="table" id="loans_tbl">
      <thead><tr><th>ID</th><th>Sách</th><th>Bạn đọc</th><th>Hết hạn</th><th>Gia hạn</th><th>Trả</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>
{% endblock %}

{% block scripts %}
<script>
  if(!getToken()) { location.href='/login'; }

  // ===== Auto-complete sách & bạn đọc =====
  const debounce = (fn, ms=250) => { let t; return (...a)=>{clearTimeout(t); t=setTimeout(()=>fn(...a), ms)} };
  const bookInput = document.getElementById('book_search');
  const bookSuggest = document.getElementById('book_suggest');
  const memberInput = document.getElementById('member_search');
  const memberSuggest = document.getElementById('member_suggest');

  function renderSuggest(ul, items, getLabel){
    ul.innerHTML = '';
    items.forEach(it=>{
      const li = document.createElement('li');
      li.dataset.id = it.id;
      li.dataset.label = getLabel(it);
      li.textContent = li.dataset.label;
      ul.appendChild(li);
    });
    ul.classList.toggle('hidden', items.length===0);
  }

  const searchBooks = debounce(async () => {
    const q = bookInput.value.trim();
    if(!q){ renderSuggest(bookSuggest, [], x=>x); return; }
    const r = await authFetch('/api/v1/books?search='+encodeURIComponent(q)+'&page_size=10');
    const d = await r.json();
    renderSuggest(bookSuggest, d.data, b => `#${b.id} — ${b.title} (${b.author})`);
  });

  const searchMembers = debounce(async () => {
    const q = memberInput.value.trim();
    if(!q){ renderSuggest(memberSuggest, [], x=>x); return; }
    const r = await authFetch('/api/v1/members?search='+encodeURIComponent(q)+'&page_size=10');
    const d = await r.json();
    renderSuggest(memberSuggest, d.data, m => `#${m.id} — ${m.code} — ${m.name}`);
  });

  bookInput.addEventListener('input', searchBooks);
  memberInput.addEventListener('input', searchMembers);

  bookSuggest.addEventListener('click', e=>{
    const li = e.target.closest('li'); if(!li) return;
    document.querySelector('input[name="book_id"]').value = li.dataset.id;
    bookInput.value = li.dataset.label;
    bookSuggest.classList.add('hidden');
  });
  memberSuggest.addEventListener('click', e=>{
    const li = e.target.closest('li'); if(!li) return;
    document.querySelector('input[name="member_id"]').value = li.dataset.id;
    memberInput.value = li.dataset.label;
    memberSuggest.classList.add('hidden');
  });

  // ===== Logic tạo loan + bảng đang mượn =====
  const form = document.getElementById('loan-form');
  const msg = document.getElementById('loan-msg');
  const tbl = document.querySelector('#loans_tbl tbody');

  async function load(){
    const res = await authFetch('/api/v1/loans?status=ACTIVE&sort=due_at:asc');
    const data = await res.json();
    tbl.innerHTML='';
    data.data.forEach(l=>{
      const tr = document.createElement('tr');
      const due = new Date(l.due_at).toLocaleString();
      tr.innerHTML = `
        <td>${l.id}</td>
        <td>${l.book?.title||('#'+l.book_id)}</td>
        <td>${l.member?.name||('#'+l.member_id)}</td>
        <td>${due}</td>
        <td><button data-renew="${l.id}">+7 ngày</button></td>
        <td><button data-return="${l.id}">Trả</button></td>`;
      tbl.appendChild(tr);
    });
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    msg.textContent = '';
    const fd = new FormData(form);
    const payload = {
      book_id: parseInt(fd.get('book_id')),
      member_id: parseInt(fd.get('member_id')),
      due_days: parseInt(fd.get('due_days')||'14')
    };
    if(!payload.book_id || !payload.member_id){
      msg.textContent = 'Bạn cần chọn sách và bạn đọc từ gợi ý.'; return;
    }
    const res = await authFetch('/api/v1/loans', { method:'POST', body: JSON.stringify(payload) });
    const d = await res.json();
    if(res.ok){ load(); form.reset(); }
    else { msg.textContent = d?.error?.message || 'Không tạo được phiếu mượn'; }
  });

  document.querySelector('#loans_tbl').addEventListener('click', async (e)=>{
    const rid = e.target.getAttribute('data-return');
    const nid = e.target.getAttribute('data-renew');
    if(rid){
      const res = await authFetch(`/api/v1/loans/${rid}/return`, { method:'POST' });
      if(res.ok) load();
    }
    if(nid){
      const res = await authFetch(`/api/v1/loans/${nid}/renew`, { method:'POST', body: JSON.stringify({extra_days:7}) });
      const d = await res.json();
      if(!res.ok) alert(d?.error?.message||'Gia hạn lỗi'); else load();
    }
  });

  load();
</script>
{% endblock %}
